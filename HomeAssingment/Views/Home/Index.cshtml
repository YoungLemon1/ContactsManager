@model List<HomeAssignment.Models.Contact>;

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>

    function RouteToContactDetails(id) {
        window.location.href = '@Url.Action("Index", "ContactDetails")' + '?id=' + id;
    }

    function RouteToNewContact() {
        window.location.href = '@Url.Action("Index", "NewContact")';
    }

    <!-- #editPhone -->
    var editing = false;

    function ToggleEditPhone(id) {
        const phoneInput = document.getElementById(id + "phone");
        const editBtn = document.getElementById(id + "edit-btn");
        const saveBtn = document.getElementById(id + "save-btn");

        if (editing) {
            phoneInput.setAttribute("disabled", true);
            saveBtn.setAttribute("disabled", true);
            editBtn.style.backgroundColor = "#FFA500";
            editBtn.textContent = "Edit ✏";
        } else {
            phoneInput.removeAttribute("disabled");
            saveBtn.removeAttribute("disabled");
            editBtn.style.backgroundColor = "#6D071A";
            editBtn.textContent = "X";
        }
        editing = !editing;
    }

    async function SavePhone(id) {
        const phoneInput = document.getElementById(id + "phone");
        const phone = phoneInput.value;
        const editBtn = document.getElementById(id + "edit-btn");
        const saveBtn = document.getElementById(id + "save-btn");

        const existingWarning = document.getElementById(id + "warning");
        if (existingWarning) {
            existingWarning.remove();
            phoneInput.style.borderColor = "inherit";
        }

        // Validation: Check if phone length is not 10
        if (phone.length !== 10 || !/^\d{10}$/.test(phone)) {
            phoneInput.style.borderColor = "red";
            const warningMessage = document.createElement("div");
            warningMessage.id = id + "warning";
            warningMessage.style.color = "red";
            warningMessage.style.marginTop = "5px";
            warningMessage.style.fontSize = "8px";
            warningMessage.textContent = "Phone number must be 10 digits.";
            phoneInput.insertAdjacentElement("afterend", warningMessage);
            return;
        }

        try {
            const response = await fetch('@Url.Action("SavePhone", "Home")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id: id, phone: phone })
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Server responded with an error:', response.status, errorText);
                throw new Error(`HTTP error! status: ${response.status}`);
            }


            const data = await response.json();

            if (data.success) {
                console.log('Phone number updated successfully.');
                ToggleEditPhone(id);
            } else {
                console.error('Failed to update phone number.');
            }
        } catch (error) {
            console.error('Error parsing JSON:', error);
            console.log('Response text:', await response.text());
        }
    }

    <!-- #endregion -->


    function ResetAllCheckboxes() {
        $('.contacts-body input[type="checkbox"]').prop('checked', false);
    }

    function DeleteContacts() {
        var markedRows = $('.contacts-body input[type="checkbox"]:checked').closest('tr');
        var numEntries = markedRows.length;
        if (numEntries > 0) {
            var message = 'Are you sure you want to delete ' + numEntries + ' entry(s)?';
            if (confirm(message)) {
                var masterCheckboxChecked = $('#master-checkbox').is(':checked');
                if (masterCheckboxChecked) {
                    $.ajax({
                        url: '@Url.Action("DeleteAllContacts")',
                        success: function () {
                            alert('Item(s) deleted');
                            window.location.reload();
                        },
                        error: function () {
                            alert('Error deleting contacts.');
                        }
                    });
                }
                else {
                    var ids = [];
                    console.log(markedRows); // check if markedRows has the expected rows
                    markedRows.each(function () {
                        console.log($(this).attr('id')); // check if this gives the expected id
                        ids.push($(this).attr('id'));
                    });
                    console.log(ids);
                    $.ajax({
                        type: 'POST',
                        url: '@Url.Action("DeleteMarked")',
                        data: JSON.stringify(ids),
                        contentType: 'application/json; charset=utf - 8',
                        success: function () {
                            alert('Item(s) deleted');
                            window.location.reload();
                        },
                        error: function () {
                            alert('Error deleting contacts.');
                        }
                    });
                }
                ResetAllCheckboxes();
            }
        }
        else {
            alert('Please select at least one entry to delete.');
        }
    }
    //Apply Route to contact details to every clickable table cell
    $(document).ready(function () {
        $('td.clickable').click(function () {
            var id = $(this).parent().attr('id');
            RouteToContactDetails(id)
        })
    });
    //checkbox checked/uncheked
    $(document).ready(function () {
        $('.contacts-body td.checkbox-cell input[type="checkbox"]').change(function () {
            var checked = $(this).prop('checked');
            var tr = $(this).closest('tr').get(0);
            checked ? tr.classList.add("selected") : tr.classList.remove("selected");
        });
    });

    //master checkbox checked/uncheked
    $(document).ready(function () {
        // Synchronize checkbox state
        $('#master-checkbox').change(function () {
            var checked = $(this).is(':checked');
            $('.contacts-body input[type="checkbox"]').prop('checked', checked).trigger('change');
        });
    });

    // Enable/disable delete button
    $(document).ready(function () {
        $('.contacts-body input[type="checkbox"]').change(function () {
            var isSomeChecked = $('.contacts-body input[type="checkbox"]:checked').length > 0;
            $('#delete-btn').prop('disabled', !isSomeChecked);
            var isNotChecked = !$(this).is(':checked');
            var isMasterChecked = $('#master-checkbox').is(':checked');
            if (isMasterChecked && isNotChecked) {
                $('#master-checkbox').prop('checked', false);
            }
        });
    });

    // reset the state of the checkbox once the route has changed
    $(document).ready(function () {
        $('.route-changer, td:not(.checkbox-cell)').click(function () {
            ResetAllCheckboxes();
        });
    });
</script>

<h3>Contacts Page</h3>
<table id="contacts-table" border="1" class="table table-bordered table-responsive">
    <thead>
        <tr class="table-primary">
            <th id="master-checkbox-cell" class="checkbox-cell"><input id="master-checkbox" type="checkbox" /></th>
            <th>ID</th>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Phone Number</th>
        </tr>
    </thead>
    <tbody class="contacts-body">
        @{
            foreach (var contact in Model)
            {
                string contactPhoneId = contact.Id!.ToString() + "phone";
                string editBtnId = contact.Id!.ToString() + "edit-btn";
                string saveBtnId = contact.Id!.ToString() + "save-btn";
                    <tr id="@contact.Id">
                        <td class="checkbox-cell"><input type="checkbox" /></td>
                        <td class="clickable">@contact.Id</td>
                        <td class="clickable">@contact.FirstName</td>
                        <td class="clickable">@contact.LastName</td>
                        <td id="contact-phone">
                            <input id="@contactPhoneId" value="@contact.Phone" disabled />
                            <button id="@editBtnId" class="btn btn-warning" onclick="ToggleEditPhone(@contact.Id)">Edit ✏</button>
                            <button id="@saveBtnId" class="btn btn-success" onclick="SavePhone(@contact.Id)" disabled> Save </button>
                        </td>
                    </tr>
            }
        }
    </tbody>

</table>


<button id="new-contact-btn" class="btn btn-primary route-changer" onclick="RouteToNewContact()">+ New Contact</button>
<button id="delete-btn" class="btn btn-danger" onclick="DeleteContacts()" disabled>Delete</button>